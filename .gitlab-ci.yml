stages:
  - init
  - build

variables:
  PLATFORM: 'agent'
  DIRECTORY_DEV: "${PLATFORM}_${CI_COMMIT_SHORT_SHA}_development_2020"
  DIRECTORY_STG: "${PLATFORM}_${CI_COMMIT_SHORT_SHA}_staging_2020"
  DIRECTORY_MST: "${PLATFORM}_${CI_COMMIT_SHORT_SHA}_master_2020"

onbuild-docker:
  image: docker:git
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  after_script:
    - docker logout
  services:
    - docker:dind
  stage: init
  script:
    - docker build -t $CI_REGISTRY_IMAGE:onbuild -f Dockerfile.onbuild --build-arg GIT_USER="gitlab-ci-token" --build-arg GIT_TOKEN="${CI_JOB_TOKEN}" .
    - docker push $CI_REGISTRY_IMAGE:onbuild
    - docker rmi $CI_REGISTRY_IMAGE:onbuild
  tags:
    - docker
  only:
    refs:
      - branches
    variables:
      - $ONBUILD_RUN == "OK"

build_development:
  image: $CI_REGISTRY_IMAGE:onbuild
  stage: build
  before_script:
    - export FILENAME=${PLATFORM}_${CI_COMMIT_SHORT_SHA}_$(TZ=GMT-7 date +%Y%m%d).tar.gz
  script:
    - ./build.sh development
    - mkdir -p $DIRECTORY_DEV
#    - tar czf $DIRECTORY_DEV/$FILENAME -C ./android/app/build/outputs/apk/release/ .
    - ls -lah *
    - tar czf $DIRECTORY_DEV/development.tar.gz -C ./android/app/build/outputs/apk/release/ .
    - ls $DIRECTORY_DEV
  only:
    refs:
      - development
    variables:
      - $DEVELOPMENT == "DEVELOPMENT"

  artifacts:
    name: $DIRECTORY_DEV
    paths:
      - $DIRECTORY_DEV/
    expire_in: 3 days

build_staging:
  image: $CI_REGISTRY_IMAGE:onbuild
  stage: build
  before_script:
    - export FILENAME=${PLATFORM}_${CI_COMMIT_SHORT_SHA}_$(TZ=GMT-7 date +%Y%m%d).tar.gz
  script:
    - ./build.sh staging
    - mkdir -p $DIRECTORY_STG
    - ls -lah *
    - tar czf $DIRECTORY_STG/staging.tar.gz -C ./android/app/build/outputs/apk/release/ .
    - ls $DIRECTORY_STG
  only:
    refs:
      - staging
    variables:
      - $STAGING == "STAGING"

  artifacts:
    name: $DIRECTORY_STG
    paths:
      - $DIRECTORY_STG/
    expire_in: 7 days


build_master:
  image: $CI_REGISTRY_IMAGE:onbuild
  stage: build
  before_script:
    - export FILENAME=${PLATFORM}_${CI_COMMIT_SHORT_SHA}_$(TZ=GMT-7 date +%Y%m%d).tar.gz
  script:
    - ./build.sh master
    - mkdir -p $DIRECTORY_MST
    - ls -lah *
    - tar czf $DIRECTORY_MST/master.tar.gz -C ./android/app/build/outputs/apk/release/ .
    - ls $DIRECTORY_MST
  only:
    refs:
      - master
    variables:
      - $MASTER == "MASTER"

  artifacts:
    name: $DIRECTORY_MST
    paths:
      - $DIRECTORY_MST/
    expire_in: 7 days


